"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var rs = require("jsrsasign");
var RSAUtils = /** @class */ (function () {
    function RSAUtils() {
    }
    RSAUtils.prototype.encriptaRSA = function (clearText, publicRSAKey /*: RSAKey*/) {
        var encript = rs.KJUR.crypto.Cipher.encrypt(clearText, publicRSAKey, "RSA");
        return rs.hextob64(encript); // no padding
    };
    RSAUtils.prototype.desencriptaRSA = function (value, privateKey) {
        var decrypted = null;
        try {
            decrypted = privateKey.decrypt(value).toString();
        }
        catch (err) {
            console.log(err);
            return this.desencriptaRSAOld(value, privateKey.exportPemKey());
        }
        console.log("desencriptaRSA : " + value + " - " + decrypted);
        return decrypted;
    };
    RSAUtils.prototype.desencriptaRSAOld = function (encryptedDataB64, privateRSAKey) {
        console.log("\ndesencriptaRSA - encryptedData:", encryptedDataB64);
        var encryptedDataHex = rs.b64tohex(encryptedDataB64);
        if (encryptedDataHex == null) {
            console.log("ES NULLLLL");
        }
        var decryptedDataHex = null;
        console.log("---------------------------------------------");
        console.log("desencriptaRSA - decryptedDataHex", decryptedDataHex);
        var i = 0;
        while (decryptedDataHex == null) {
            if (i == 0) {
                encryptedDataHex = rs.b64nltohex(encryptedDataB64);
            }
            if (i == 1) {
                encryptedDataHex = rs.b64utohex(encryptedDataB64);
            }
            if (i == 2) {
                encryptedDataHex = rs.b64tohex(encryptedDataB64);
                i = -1;
            }
            decryptedDataHex = rs.KJUR.crypto.Cipher.decrypt(encryptedDataHex, privateRSAKey, "RSA");
            console.log("desencriptaRSA - decryptedDataHex " + i + " : ", decryptedDataHex);
            if (decryptedDataHex == null && i == -1) {
                return null;
            }
            i = i + 1;
        }
        return decryptedDataHex;
    };
    /**desencriptaRSA(encryptedDataB64, privateRSAKey) {
          console.log("\ndesencriptaRSA - encryptedData:",encryptedDataB64);
          //console.log("privateRSAKey_B64", this.privateKeyToBase64(privateRSAKey));
  
          encryptedDataB64 = encryptedDataB64.trim();
          let privKeyB64 = this.privateKeyToBase64(privateRSAKey);
          let privateKey = this.base64ToPrivateKey(privKeyB64);
          let encryptedDataHex = rs.b64nltohex(encryptedDataB64);
          if (encryptedDataHex == null) {console.log("ES NULLLLL")}
          let decryptedDataHex = null;
          console.log("---------------------------------------------");
          console.log("desencriptaRSA - decryptedDataHex", decryptedDataHex);
  
          let i=0;
  
          while(decryptedDataHex==null){
  
            if (i==0){ encryptedDataHex = rs.b64tohex(encryptedDataB64); }
            if (i==1){ encryptedDataHex = rs.b64utohex(encryptedDataB64); }
            if (i==2){ encryptedDataHex = rs.b64tohex(encryptedDataB64); i=-1; }
  
            decryptedDataHex = rs.KJUR.crypto.Cipher.decrypt(encryptedDataHex, privateKey, "RSA");
            console.log("desencriptaRSA - decryptedDataHex " + i + " : ", decryptedDataHex);
  
            if (decryptedDataHex == null && i==-1){
              return null;
            }
  
            i = i +1;
          }
  
          return decryptedDataHex;
      }*/
    RSAUtils.prototype.generaRSAKey = function () {
        // Genere la llave pública y privada del dispositivo
        return rs.KEYUTIL.generateKeypair("RSA", 2048);
    };
    RSAUtils.prototype.extraePublicKey = function (rsaKeyPair) {
        return rsaKeyPair.pubKeyObj;
    };
    RSAUtils.prototype.extraePrivateKey = function (rsaKeyPair) {
        return rsaKeyPair.prvKeyObj;
    };
    RSAUtils.prototype.pemToKey = function (pemKey) {
        return rs.KEYUTIL.getKey(pemKey);
    };
    RSAUtils.generaPubKeyFromModulus = function (modulus, exponent) {
        // Not implemented
    };
    //static descomponePubKey(keyPairRSA) {
    RSAUtils.prototype.descomponePubKey = function (publicRSAKey) {
        // Descompone una llave pública (RSA Puro) en sus partes:
        // Modulus y Exponent.
        // Regresa un JSON con ambas partes codificado en Base64.
        // let pubKeyRSA = keyPairRSA.pubKeyObj;
        return this.getExponentAndModulusFromPubKey(publicRSAKey);
    };
    RSAUtils.prototype.getExponentAndModulusFromPubKey = function (pubKeyRSA) {
        var exponent = new rs.BigInteger(pubKeyRSA.e.toString());
        var exponentBA = exponent.toByteArray();
        var exponentHex = RSAUtils.toHexString(exponentBA);
        var exponentB64 = rs.hextob64(exponentHex); // DO Match with Java
        // ---
        var modulus = pubKeyRSA.n;
        var modulusBA = modulus.toByteArray();
        var moduluxHex = RSAUtils.toHexString(modulusBA); //rs.BAtohex(modulusBA);
        var modulusB64 = rs.hextob64(moduluxHex); // DO NOT Match with Java, convert from bytes, not from string representation *******
        return {
            "exponent": exponent.toString(),
            "exponentBA": exponentBA,
            "exponentB64": exponentB64,
            "exponentHex": exponentHex,
            "modulus": modulus.toString(),
            "modulusBA": modulusBA,
            "modulusB64": modulusB64,
            "modulusHex": moduluxHex
        };
    };
    RSAUtils.prototype.publicKeyToBase64 = function (publicRSAKey) {
        var pubKeyPEM = rs.KEYUTIL.getPEM(publicRSAKey);
        var pubKeyHex = rs.pemtohex(pubKeyPEM, "PUBLIC KEY");
        return rs.hextob64(pubKeyHex);
    };
    RSAUtils.prototype.privateKeyToBase64 = function (privateRSAKey) {
        var prvKeyPEM = rs.KEYUTIL.getPEM(privateRSAKey, "PKCS1PRV");
        var prvKeyHex = rs.pemtohex(prvKeyPEM, "RSA PRIVATE KEY");
        return rs.hex2b64(prvKeyHex);
    };
    RSAUtils.prototype.base64ToPublicKey = function (base64PubKey) {
        var pubKeyPEM = rs.hextopem(rs.b64tohex(base64PubKey), 'PUBLIC KEY');
        return rs.KEYUTIL.getKey(pubKeyPEM); // RSAKey
    };
    RSAUtils.prototype.base64ToPrivateKey = function (base64PrivKey) {
        var pubKeyPEM = rs.hextopem(rs.b64tohex(base64PrivKey), 'RSA PRIVATE KEY');
        return rs.KEYUTIL.getKey(pubKeyPEM); // RSAKey
    };
    RSAUtils.toHexString = function (byteArray) {
        return Array.prototype.map.call(byteArray, function (byte) {
            return ('0' + (byte & 0xFF).toString(16)).slice(-2);
        }).join('');
    };
    RSAUtils.toByteArray = function (hexString) {
        var result = [];
        while (hexString.length >= 2) {
            result.push(parseInt(hexString.substring(0, 2), 16));
            hexString = hexString.substring(2, hexString.length);
        }
        return result;
    };
    return RSAUtils;
}());
exports.RSAUtils = RSAUtils;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnNhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicnNhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOEJBQWdDO0FBRWhDO0lBQUE7SUE4S0EsQ0FBQztJQTVLQyw4QkFBVyxHQUFYLFVBQVksU0FBUyxFQUFFLFlBQVksQ0FBQyxZQUFZO1FBQzlDLElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM1RSxNQUFNLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGFBQWE7SUFDNUMsQ0FBQztJQUVELGlDQUFjLEdBQWQsVUFBZSxLQUFLLEVBQUUsVUFBVTtRQUM5QixJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFFckIsSUFBSSxDQUFDO1lBQ0gsU0FBUyxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDbkQsQ0FBQztRQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDYixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ2xFLENBQUM7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixHQUFHLEtBQUssR0FBRyxLQUFLLEdBQUcsU0FBUyxDQUFDLENBQUM7UUFDN0QsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQsb0NBQWlCLEdBQWpCLFVBQWtCLGdCQUFnQixFQUFFLGFBQWE7UUFDL0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBRW5FLElBQUksZ0JBQWdC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QUFDLENBQUM7SUFDZCxDQUFDO0lBRU0sb0JBQVcsR0FBbEIsVUFBbUIsU0FBUztRQUMxQixJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDaEIsT0FBTyxTQUFTLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzdCLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDckQsU0FBUyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN2RCxDQUFDO1FBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBQ0gsZUFBQztBQUFELENBQUMsQUE5S0QsSUE4S0M7QUE5S1ksNEJBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBycyBmcm9tIFwianNyc2FzaWduXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgUlNBVXRpbHMge1xyXG5cclxuICBlbmNyaXB0YVJTQShjbGVhclRleHQsIHB1YmxpY1JTQUtleSAvKjogUlNBS2V5Ki8pIHtcclxuICAgIGxldCBlbmNyaXB0ID0gcnMuS0pVUi5jcnlwdG8uQ2lwaGVyLmVuY3J5cHQoY2xlYXJUZXh0LCBwdWJsaWNSU0FLZXksIFwiUlNBXCIpO1xyXG4gICAgcmV0dXJuIHJzLmhleHRvYjY0KGVuY3JpcHQpOyAvLyBubyBwYWRkaW5nXHJcbiAgfVxyXG5cclxuICBkZXNlbmNyaXB0YVJTQSh2YWx1ZSwgcHJpdmF0ZUtleSkge1xyXG4gICAgbGV0IGRlY3J5cHRlZCA9IG51bGw7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgZGVjcnlwdGVkID0gcHJpdmF0ZUtleS5kZWNyeXB0KHZhbHVlKS50b1N0cmluZygpO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgIHJldHVybiB0aGlzLmRlc2VuY3JpcHRhUlNBT2xkKHZhbHVlLCBwcml2YXRlS2V5LmV4cG9ydFBlbUtleSgpKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLmxvZyhcImRlc2VuY3JpcHRhUlNBIDogXCIgKyB2YWx1ZSArIFwiIC0gXCIgKyBkZWNyeXB0ZWQpO1xyXG4gICAgcmV0dXJuIGRlY3J5cHRlZDtcclxuICB9XHJcblxyXG4gIGRlc2VuY3JpcHRhUlNBT2xkKGVuY3J5cHRlZERhdGFCNjQsIHByaXZhdGVSU0FLZXkpIHtcclxuICAgIGNvbnNvbGUubG9nKFwiXFxuZGVzZW5jcmlwdGFSU0EgLSBlbmNyeXB0ZWREYXRhOlwiLCBlbmNyeXB0ZWREYXRhQjY0KTtcclxuXHJcbiAgICBsZXQgZW5jcnlwdGVkRGF0YUhleCA9IHJzLmI2NHRvaGV4KGVuY3J5cHRlZERhdGFCNjQpO1xyXG4gICAgaWYgKGVuY3J5cHRlZERhdGFIZXggPT0gbnVsbCkgeyBjb25zb2xlLmxvZyhcIkVTIE5VTExMTExcIikgfVxyXG4gICAgbGV0IGRlY3J5cHRlZERhdGFIZXggPSBudWxsO1xyXG4gICAgY29uc29sZS5sb2coXCItLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cIik7XHJcbiAgICBjb25zb2xlLmxvZyhcImRlc2VuY3JpcHRhUlNBIC0gZGVjcnlwdGVkRGF0YUhleFwiLCBkZWNyeXB0ZWREYXRhSGV4KTtcclxuXHJcbiAgICBsZXQgaSA9IDA7XHJcblxyXG4gICAgd2hpbGUgKGRlY3J5cHRlZERhdGFIZXggPT0gbnVsbCkge1xyXG5cclxuICAgICAgaWYgKGkgPT0gMCkgeyBlbmNyeXB0ZWREYXRhSGV4ID0gcnMuYjY0bmx0b2hleChlbmNyeXB0ZWREYXRhQjY0KTsgfVxyXG4gICAgICBpZiAoaSA9PSAxKSB7IGVuY3J5cHRlZERhdGFIZXggPSBycy5iNjR1dG9oZXgoZW5jcnlwdGVkRGF0YUI2NCk7IH1cclxuICAgICAgaWYgKGkgPT0gMikgeyBlbmNyeXB0ZWREYXRhSGV4ID0gcnMuYjY0dG9oZXgoZW5jcnlwdGVkRGF0YUI2NCk7IGkgPSAtMTsgfVxyXG5cclxuICAgICAgZGVjcnlwdGVkRGF0YUhleCA9IHJzLktKVVIuY3J5cHRvLkNpcGhlci5kZWNyeXB0KGVuY3J5cHRlZERhdGFIZXgsIHByaXZhdGVSU0FLZXksIFwiUlNBXCIpO1xyXG4gICAgICBjb25zb2xlLmxvZyhcImRlc2VuY3JpcHRhUlNBIC0gZGVjcnlwdGVkRGF0YUhleCBcIiArIGkgKyBcIiA6IFwiLCBkZWNyeXB0ZWREYXRhSGV4KTtcclxuXHJcbiAgICAgIGlmIChkZWNyeXB0ZWREYXRhSGV4ID09IG51bGwgJiYgaSA9PSAtMSkge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpID0gaSArIDE7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGRlY3J5cHRlZERhdGFIZXg7XHJcbiAgfVxyXG5cclxuICAvKipkZXNlbmNyaXB0YVJTQShlbmNyeXB0ZWREYXRhQjY0LCBwcml2YXRlUlNBS2V5KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJcXG5kZXNlbmNyaXB0YVJTQSAtIGVuY3J5cHRlZERhdGE6XCIsZW5jcnlwdGVkRGF0YUI2NCk7XHJcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcInByaXZhdGVSU0FLZXlfQjY0XCIsIHRoaXMucHJpdmF0ZUtleVRvQmFzZTY0KHByaXZhdGVSU0FLZXkpKTtcclxuXHJcbiAgICAgICAgZW5jcnlwdGVkRGF0YUI2NCA9IGVuY3J5cHRlZERhdGFCNjQudHJpbSgpO1xyXG4gICAgICAgIGxldCBwcml2S2V5QjY0ID0gdGhpcy5wcml2YXRlS2V5VG9CYXNlNjQocHJpdmF0ZVJTQUtleSk7XHJcbiAgICAgICAgbGV0IHByaXZhdGVLZXkgPSB0aGlzLmJhc2U2NFRvUHJpdmF0ZUtleShwcml2S2V5QjY0KTtcclxuICAgICAgICBsZXQgZW5jcnlwdGVkRGF0YUhleCA9IHJzLmI2NG5sdG9oZXgoZW5jcnlwdGVkRGF0YUI2NCk7XHJcbiAgICAgICAgaWYgKGVuY3J5cHRlZERhdGFIZXggPT0gbnVsbCkge2NvbnNvbGUubG9nKFwiRVMgTlVMTExMTFwiKX1cclxuICAgICAgICBsZXQgZGVjcnlwdGVkRGF0YUhleCA9IG51bGw7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCItLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cIik7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJkZXNlbmNyaXB0YVJTQSAtIGRlY3J5cHRlZERhdGFIZXhcIiwgZGVjcnlwdGVkRGF0YUhleCk7XHJcblxyXG4gICAgICAgIGxldCBpPTA7XHJcblxyXG4gICAgICAgIHdoaWxlKGRlY3J5cHRlZERhdGFIZXg9PW51bGwpe1xyXG5cclxuICAgICAgICAgIGlmIChpPT0wKXsgZW5jcnlwdGVkRGF0YUhleCA9IHJzLmI2NHRvaGV4KGVuY3J5cHRlZERhdGFCNjQpOyB9XHJcbiAgICAgICAgICBpZiAoaT09MSl7IGVuY3J5cHRlZERhdGFIZXggPSBycy5iNjR1dG9oZXgoZW5jcnlwdGVkRGF0YUI2NCk7IH1cclxuICAgICAgICAgIGlmIChpPT0yKXsgZW5jcnlwdGVkRGF0YUhleCA9IHJzLmI2NHRvaGV4KGVuY3J5cHRlZERhdGFCNjQpOyBpPS0xOyB9XHJcblxyXG4gICAgICAgICAgZGVjcnlwdGVkRGF0YUhleCA9IHJzLktKVVIuY3J5cHRvLkNpcGhlci5kZWNyeXB0KGVuY3J5cHRlZERhdGFIZXgsIHByaXZhdGVLZXksIFwiUlNBXCIpO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coXCJkZXNlbmNyaXB0YVJTQSAtIGRlY3J5cHRlZERhdGFIZXggXCIgKyBpICsgXCIgOiBcIiwgZGVjcnlwdGVkRGF0YUhleCk7XHJcblxyXG4gICAgICAgICAgaWYgKGRlY3J5cHRlZERhdGFIZXggPT0gbnVsbCAmJiBpPT0tMSl7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGkgPSBpICsxO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGRlY3J5cHRlZERhdGFIZXg7XHJcbiAgICB9Ki9cclxuXHJcbiAgZ2VuZXJhUlNBS2V5KCkge1xyXG4gICAgLy8gR2VuZXJlIGxhIGxsYXZlIHDDumJsaWNhIHkgcHJpdmFkYSBkZWwgZGlzcG9zaXRpdm9cclxuICAgIHJldHVybiBycy5LRVlVVElMLmdlbmVyYXRlS2V5cGFpcihcIlJTQVwiLCAyMDQ4KTtcclxuICB9XHJcblxyXG4gIGV4dHJhZVB1YmxpY0tleShyc2FLZXlQYWlyKSB7XHJcbiAgICByZXR1cm4gcnNhS2V5UGFpci5wdWJLZXlPYmo7XHJcbiAgfVxyXG5cclxuICBleHRyYWVQcml2YXRlS2V5KHJzYUtleVBhaXIpIHtcclxuICAgIHJldHVybiByc2FLZXlQYWlyLnBydktleU9iajtcclxuICB9XHJcblxyXG4gIHBlbVRvS2V5KHBlbUtleSkge1xyXG4gICAgcmV0dXJuIHJzLktFWVVUSUwuZ2V0S2V5KHBlbUtleSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2VuZXJhUHViS2V5RnJvbU1vZHVsdXMobW9kdWx1cywgZXhwb25lbnQpIHtcclxuICAgIC8vIE5vdCBpbXBsZW1lbnRlZFxyXG4gIH1cclxuXHJcbiAgLy9zdGF0aWMgZGVzY29tcG9uZVB1YktleShrZXlQYWlyUlNBKSB7XHJcbiAgZGVzY29tcG9uZVB1YktleShwdWJsaWNSU0FLZXkpIHtcclxuICAgIC8vIERlc2NvbXBvbmUgdW5hIGxsYXZlIHDDumJsaWNhIChSU0EgUHVybykgZW4gc3VzIHBhcnRlczpcclxuICAgIC8vIE1vZHVsdXMgeSBFeHBvbmVudC5cclxuICAgIC8vIFJlZ3Jlc2EgdW4gSlNPTiBjb24gYW1iYXMgcGFydGVzIGNvZGlmaWNhZG8gZW4gQmFzZTY0LlxyXG4gICAgLy8gbGV0IHB1YktleVJTQSA9IGtleVBhaXJSU0EucHViS2V5T2JqO1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0RXhwb25lbnRBbmRNb2R1bHVzRnJvbVB1YktleShwdWJsaWNSU0FLZXkpXHJcbiAgfVxyXG5cclxuICBnZXRFeHBvbmVudEFuZE1vZHVsdXNGcm9tUHViS2V5KHB1YktleVJTQSkge1xyXG4gICAgbGV0IGV4cG9uZW50ID0gbmV3IHJzLkJpZ0ludGVnZXIocHViS2V5UlNBLmUudG9TdHJpbmcoKSk7XHJcbiAgICBsZXQgZXhwb25lbnRCQSA9IGV4cG9uZW50LnRvQnl0ZUFycmF5KCk7XHJcbiAgICBsZXQgZXhwb25lbnRIZXggPSBSU0FVdGlscy50b0hleFN0cmluZyhleHBvbmVudEJBKTtcclxuICAgIGxldCBleHBvbmVudEI2NCA9IHJzLmhleHRvYjY0KGV4cG9uZW50SGV4KTsgICAvLyBETyBNYXRjaCB3aXRoIEphdmFcclxuICAgIC8vIC0tLVxyXG4gICAgbGV0IG1vZHVsdXMgPSBwdWJLZXlSU0EubjtcclxuICAgIGxldCBtb2R1bHVzQkEgPSBtb2R1bHVzLnRvQnl0ZUFycmF5KCk7XHJcbiAgICBsZXQgbW9kdWx1eEhleCA9IFJTQVV0aWxzLnRvSGV4U3RyaW5nKG1vZHVsdXNCQSk7IC8vcnMuQkF0b2hleChtb2R1bHVzQkEpO1xyXG4gICAgbGV0IG1vZHVsdXNCNjQgPSBycy5oZXh0b2I2NChtb2R1bHV4SGV4KTsgICAvLyBETyBOT1QgTWF0Y2ggd2l0aCBKYXZhLCBjb252ZXJ0IGZyb20gYnl0ZXMsIG5vdCBmcm9tIHN0cmluZyByZXByZXNlbnRhdGlvbiAqKioqKioqXHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgXCJleHBvbmVudFwiOiBleHBvbmVudC50b1N0cmluZygpLFxyXG4gICAgICBcImV4cG9uZW50QkFcIjogZXhwb25lbnRCQSxcclxuICAgICAgXCJleHBvbmVudEI2NFwiOiBleHBvbmVudEI2NCxcclxuICAgICAgXCJleHBvbmVudEhleFwiOiBleHBvbmVudEhleCxcclxuICAgICAgXCJtb2R1bHVzXCI6IG1vZHVsdXMudG9TdHJpbmcoKSxcclxuICAgICAgXCJtb2R1bHVzQkFcIjogbW9kdWx1c0JBLFxyXG4gICAgICBcIm1vZHVsdXNCNjRcIjogbW9kdWx1c0I2NCxcclxuICAgICAgXCJtb2R1bHVzSGV4XCI6IG1vZHVsdXhIZXhcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWNLZXlUb0Jhc2U2NChwdWJsaWNSU0FLZXkpIHtcclxuICAgIGxldCBwdWJLZXlQRU0gPSBycy5LRVlVVElMLmdldFBFTShwdWJsaWNSU0FLZXkpO1xyXG4gICAgbGV0IHB1YktleUhleCA9IHJzLnBlbXRvaGV4KHB1YktleVBFTSwgXCJQVUJMSUMgS0VZXCIpO1xyXG4gICAgcmV0dXJuIHJzLmhleHRvYjY0KHB1YktleUhleCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlS2V5VG9CYXNlNjQocHJpdmF0ZVJTQUtleSkge1xyXG4gICAgbGV0IHBydktleVBFTSA9IHJzLktFWVVUSUwuZ2V0UEVNKHByaXZhdGVSU0FLZXksIFwiUEtDUzFQUlZcIik7XHJcbiAgICBsZXQgcHJ2S2V5SGV4ID0gcnMucGVtdG9oZXgocHJ2S2V5UEVNLCBcIlJTQSBQUklWQVRFIEtFWVwiKTtcclxuICAgIHJldHVybiBycy5oZXgyYjY0KHBydktleUhleCk7XHJcbiAgfVxyXG5cclxuICBiYXNlNjRUb1B1YmxpY0tleShiYXNlNjRQdWJLZXkpIHtcclxuICAgIGNvbnN0IHB1YktleVBFTSA9IHJzLmhleHRvcGVtKHJzLmI2NHRvaGV4KGJhc2U2NFB1YktleSksICdQVUJMSUMgS0VZJyk7XHJcbiAgICByZXR1cm4gcnMuS0VZVVRJTC5nZXRLZXkocHViS2V5UEVNKTsgICAgLy8gUlNBS2V5XHJcbiAgfVxyXG5cclxuICBiYXNlNjRUb1ByaXZhdGVLZXkoYmFzZTY0UHJpdktleSkge1xyXG4gICAgY29uc3QgcHViS2V5UEVNID0gcnMuaGV4dG9wZW0ocnMuYjY0dG9oZXgoYmFzZTY0UHJpdktleSksICdSU0EgUFJJVkFURSBLRVknKTtcclxuICAgIHJldHVybiBycy5LRVlVVElMLmdldEtleShwdWJLZXlQRU0pOyAgICAvLyBSU0FLZXlcclxuICB9XHJcblxyXG4gIHN0YXRpYyB0b0hleFN0cmluZyhieXRlQXJyYXkpIHtcclxuICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUubWFwLmNhbGwoYnl0ZUFycmF5LCBmdW5jdGlvbihieXRlKSB7XHJcbiAgICAgIHJldHVybiAoJzAnICsgKGJ5dGUgJiAweEZGKS50b1N0cmluZygxNikpLnNsaWNlKC0yKTtcclxuICAgIH0pLmpvaW4oJycpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIHRvQnl0ZUFycmF5KGhleFN0cmluZykge1xyXG4gICAgbGV0IHJlc3VsdCA9IFtdO1xyXG4gICAgd2hpbGUgKGhleFN0cmluZy5sZW5ndGggPj0gMikge1xyXG4gICAgICByZXN1bHQucHVzaChwYXJzZUludChoZXhTdHJpbmcuc3Vic3RyaW5nKDAsIDIpLCAxNikpO1xyXG4gICAgICBoZXhTdHJpbmcgPSBoZXhTdHJpbmcuc3Vic3RyaW5nKDIsIGhleFN0cmluZy5sZW5ndGgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbn1cclxuIl19